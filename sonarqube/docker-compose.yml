services:
  sonarqube-client:
    image: sonarqube:community
    container_name: sonarqube-client
    restart: unless-stopped
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://sonarqube-database:5432/${POSTGRES_DB}
      - SONAR_JDBC_USERNAME=${POSTGRES_USER}
      - SONAR_JDBC_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
    labels:
      - docker-volume-backup.stop-during-backup=true
    depends_on:
      - sonarqube-database
    networks:
      - sonarqube_network
      - cloudflare_network
  
  sonarqube-database:
    image: postgres:17
    container_name: sonarqube-database
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    labels:
      - docker-volume-backup.stop-during-backup=true
    networks:
      - sonarqube_network

  sonarqube-backup:
    image: ghcr.io/offen/docker-volume-backup:v2.46.1@sha256:039188f012d26178e68a0bb906cd408b9fc197069e8076d03014a31a5fed1406
    container_name: sonarqube-backup
    restart: always
    environment:
      - BACKUP_RETENTION_DAYS=7
      - BACKUP_CRON_EXPRESSION=0 3 * * *
      - BACKUP_FILENAME=backup-sonarqube-%Y-%m-%dT%H-%M-%S.tar.gz
      - AWS_ENDPOINT=${AWS_ENDPOINT}
      - AWS_S3_BUCKET_NAME=${AWS_S3_BUCKET_NAME}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    volumes:
      - sonarqube_data:/backup/sonarqube_data:ro
      - sonarqube_extensions:/backup/sonarqube_extensions:ro
      - postgres_data:/backup/postgres_data:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - sonarqube_network

volumes:
  sonarqube_data:
  sonarqube_extensions:
  postgres_data:

networks:
  sonarqube_network:
    driver: bridge
  cloudflare_network:
    external: true

name: sonarqube
