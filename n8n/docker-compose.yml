x-shared: &shared
  restart: always
  image: n8nio/n8n:stable
  environment:
    - GENERIC_TIMEZONE=Asia/Ho_Chi_Minh
    - TZ=Asia/Ho_Chi_Minh
    - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
    - N8N_RUNNERS_ENABLED=true
    - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
    - N8N_BLOCK_ENV_ACCESS_IN_NODE=true
    - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
    - DB_TYPE=postgresdb
    - DB_POSTGRESDB_HOST=n8n-database
    - DB_POSTGRESDB_PORT=5432
    - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
    - DB_POSTGRESDB_USER=${POSTGRES_USER}
    - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
    - EXECUTIONS_MODE=queue
    - QUEUE_BULL_REDIS_HOST=n8n-queue
    - N8N_ENCRYPTION_KEY=${ENCRYPTION_KEY}
    - N8N_EDITOR_BASE_URL=${BASE_URL}
    - WEBHOOK_URL=${BASE_URL}
    - N8N_PROXY_HOPS=1
  volumes:
    - n8n_data:/home/node/.n8n
  labels:
    - docker-volume-backup.stop-during-backup=true
  depends_on:
    - n8n-queue
    - n8n-database

services:
  n8n-client:
    <<: *shared
    container_name: n8n-client
    networks:
      - n8n_network
      - cloudflare_network
  
  n8n-worker:
    <<: *shared
    command: worker
    networks:
      - n8n_network
 
  n8n-database:
    image: postgres:16
    container_name: n8n-database
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    labels:
      - docker-volume-backup.stop-during-backup=true
    networks:
      - n8n_network

  n8n-queue:
    image: redis:8
    container_name: n8n-queue
    restart: unless-stopped
    volumes:
      - redis_data:/data
    labels:
      - docker-volume-backup.stop-during-backup=true
    networks:
      - n8n_network
  
  n8n-backup:
    image: ghcr.io/offen/docker-volume-backup:v2.46.1@sha256:039188f012d26178e68a0bb906cd408b9fc197069e8076d03014a31a5fed1406
    container_name: n8n-backup
    restart: always
    environment:
      - BACKUP_RETENTION_DAYS=7
      - BACKUP_CRON_EXPRESSION=0 3 * * *
      - BACKUP_FILENAME=backup-n8n-%Y-%m-%dT%H-%M-%S.tar.gz
      - AWS_ENDPOINT=${AWS_ENDPOINT}
      - AWS_S3_BUCKET_NAME=${AWS_S3_BUCKET_NAME}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    volumes:
      - n8n_data:/backup/n8n_data:ro
      - postgres_data:/backup/postgres_data:ro
      - redis_data:/backup/redis_data:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - n8n_network

volumes:
  n8n_data:
  postgres_data:
  redis_data:

networks:
  n8n_network:
    driver: bridge
  cloudflare_network:
    external: true

name: n8n
